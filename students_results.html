<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = window.API_URL || '/api';
    let allStudentsData = window.allStudentsData || [];
    let currentSubject = localStorage.getItem('results_subject') || 'all';
    let currentFilter = localStorage.getItem('results_filter') || 'all';
        // Filter Results
        function renderResults() {
            const container = document.getElementById('results-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            if (!allStudentsData.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3></div>';
                return;
            }

            let filtered = allStudentsData.filter(student => {
                // 1. Text Search
                const matchName = (student.name || '').toLowerCase().includes(search);
                const matchEmail = (student.email || '').toLowerCase().includes(search);
                if (!matchName && !matchEmail) return false;

                // 2. Score Filter
                let matchScore = true;
                const score = parseFloat(student.averageScore) || 0;
                
                if (currentFilter === 'excellent') matchScore = score >= 90;
                else if (currentFilter === 'good') matchScore = score >= 75 && score < 90;
                else if (currentFilter === 'pass') matchScore = score >= 50 && score < 75;
                else if (currentFilter === 'fail') matchScore = score < 50;

                return matchScore;
            });

            if (currentSubject !== 'all') {
                filtered = filtered.filter(s => Array.isArray(s.subjects) && s.subjects.includes(currentSubject));
            }
            
            displayStudents(filtered);
            updateStats(filtered);
        }

        function displayStudents(students) {
            const container = document.getElementById('results-container');
            if (!students.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</h3></div>';
                return;
            }

            container.innerHTML = students.map(s => `
                <div class="student-card">
                    <div class="student-header">
                        <div class="student-info">
                            <div class="student-avatar">${s.name.charAt(0)}</div>
                            <div class="student-details">
                                <h3>${s.name}</h3>
                                <p>${s.email}</p>
                            </div>
                        </div>
                        <div class="overall-score">
                            <div class="score-circle" style="--score: ${s.averageScore}">
                                <div class="score-circle-inner">
                                    <span style="font-size:1.2rem; font-weight:bold;">${Math.round(s.averageScore)}%</span>
                                </div>
                            </div>
                            <div class="score-label">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…</div>
                        </div>
                    </div>
                    <div class="quiz-results">
                        <div class="quiz-item" style="text-align:center;">
                            <div class="quiz-name">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                            <div style="font-size:1.2rem; font-weight:bold;">${s.totalQuizzes}</div>
                        </div>
                        <div class="quiz-item" style="text-align:center;">
                            <div class="quiz-name">Ø£ÙØ¶Ù„ Ø¯Ø±Ø¬Ø©</div>
                            <div style="font-size:1.2rem; font-weight:bold; color:var(--success);">${s.bestScore}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats(students) {
            document.getElementById('total-students').innerText = students.length;
            const totalTests = students.reduce((acc, s) => acc + parseInt(s.totalQuizzes), 0);
            document.getElementById('total-tests').innerText = totalTests;
            
            if (students.length) {
                const avg = students.reduce((acc, s) => acc + parseFloat(s.averageScore), 0) / students.length;
                document.getElementById('avg-score').innerText = Math.round(avg) + '%';
                
                const max = Math.max(...students.map(s => parseFloat(s.bestScore)));
                document.getElementById('top-score').innerText = max + '%';
            } else {
                document.getElementById('avg-score').innerText = '0%';
                document.getElementById('top-score').innerText = '0%';
            }
        }

        // Fetch Data
        async function loadData() {
            try {
                document.getElementById('results-container').innerHTML = '<div class="spinner"></div>';
                const res = await fetch(`${API_URL}/public/students-detailed`);
                if (!res.ok) throw new Error('Failed to load');
                allStudentsData = await res.json();
                renderResults();
            } catch (e) {
                document.getElementById('results-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <button onclick="loadData()" class="btn" style="width:auto; border-radius:10px; padding:10px 20px; margin-top:20px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                    </div>
                `;
            }
        }

        const searchInputEl = document.getElementById('search-input');
        if (searchInputEl) searchInputEl.addEventListener('input', renderResults);

        // Init
        if (typeof initFilters === 'function') initFilters();
        loadData();
});
    </script>
